<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Feedback App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 25px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .main {
            padding: 30px 20px;
        }
        
        .player-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .workflow-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .player-btn {
            background: #ecf0f1;
            border: none;
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            position: relative;
        }
        
        .player-btn:hover {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
        }
        
        .feedback-btn.selected {
            background: #e74c3c;
            color: white;
        }
        
        .attendance-btn.present {
            background: #27ae60;
            color: white;
        }
        
        .attendance-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #27ae60;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .session-setup {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }
        
        .export-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
        }
        
        .export-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 5px;
        }
        
        .export-btn:hover {
            background: #219a52;
        }
        
        .category-section {
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .record-mini-btn {
            background: #e74c3c;
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            display: inline-block;
            margin: 5px 0;
            font-size: 14px;
            user-select: none;
            border: none;
        }
        
        .record-mini-btn:hover {
            background: #c0392b;
        }
        
        .record-mini-btn.recording {
            background: #27ae60;
            animation: pulse 1.5s infinite;
        }
        
        .audio-status {
            font-size: 12px;
            color: #7f8c8d;
            margin: 5px 0;
        }
        
        .feedback-categories {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .feedback-list {
            margin-top: 30px;
        }
        
        .feedback-item {
            background: #ecf0f1;
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .player-name {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .timestamp {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .play-btn {
            background: #3498db;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .play-btn:hover {
            background: #2980b9;
        }
        
        .clear-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚽ Training Feedback</h1>
            <p>Roehampton Elite FC</p>
        </div>

        <div class="main">
            <div class="session-setup">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Session Details:</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <select id="teamSelect" style="padding: 10px; border-radius: 8px; border: 1px solid #bdc3c7;">
                        <option value="">Select Team</option>
                        <option value="Pre Academy">Pre Academy</option>
                        <option value="Development">Development</option>
                        <option value="Elite">Elite</option>
                    </select>
                    <select id="locationSelect" style="padding: 10px; border-radius: 8px; border: 1px solid #bdc3c7;">
                        <option value="">Training Location</option>
                        <option value="Richmond Park Academy">Richmond Park Academy</option>
                        <option value="St Paul's School">St Paul's School</option>
                    </select>
                </div>
                <input type="date" id="sessionDate" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #bdc3c7;">
            </div>
            
            <div class="workflow-section">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Step 1: Mark Attendance</h3>
                <div class="player-grid">
                    <button class="player-btn attendance-btn" data-player="Jake Smith">
                        Jake Smith
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Mike Johnson">
                        Mike Johnson
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Sam Wilson">
                        Sam Wilson
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Tom Brown">
                        Tom Brown
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Alex Davis">
                        Alex Davis
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Ryan Miller">
                        Ryan Miller
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                </div>
            </div>
            
            <div class="workflow-section">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Step 2: Record Player Feedback</h3>
                <div class="player-grid">
                    <button class="player-btn feedback-btn" data-player="Jake Smith">Jake Smith</button>
                    <button class="player-btn feedback-btn" data-player="Mike Johnson">Mike Johnson</button>
                    <button class="player-btn feedback-btn" data-player="Sam Wilson">Sam Wilson</button>
                    <button class="player-btn feedback-btn" data-player="Tom Brown">Tom Brown</button>
                    <button class="player-btn feedback-btn" data-player="Alex Davis">Alex Davis</button>
                    <button class="player-btn feedback-btn" data-player="Ryan Miller">Ryan Miller</button>
                </div>
                
                <div class="feedback-categories" id="feedbackCategories" style="display: none;">
                    <h4 style="margin: 20px 0 10px 0; color: #2c3e50;">Feedback for <span id="selectedPlayerName"></span>:</h4>
                    
                    <div class="category-section">
                        <label style="font-weight: bold; color: #2c3e50;">⭐ Overall Performance:</label>
                        <select id="overallRating" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 5px; border: 1px solid #bdc3c7;">
                            <option value="">Select rating</option>
                            <option value="Excellent">Excellent</option>
                            <option value="Very Good">Very Good</option>
                            <option value="Good">Good</option>
                            <option value="Average">Average</option>
                            <option value="Needs Improvement">Needs Improvement</option>
                        </select>
                    </div>
                    
                    <div class="category-section">
                        <label style="font-weight: bold; color: #3498db;">🎤 Voice Feedback:</label>
                        <button class="record-mini-btn" data-category="feedback">🎤 Record</button>
                        <div class="audio-status" id="feedbackStatus"></div>
                    </div>
                    
                    <div class="category-section">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-weight: bold; color: #f39c12;">🏆 Special mentions:</label>
                            <label style="font-size: 14px;"><input type="checkbox" id="specialMention"> Special mention</label>
                            <label style="font-size: 14px;"><input type="checkbox" id="playerOfSession"> Player of session</label>
                        </div>
                    </div>
                    
                    <button onclick="saveFeedback()" style="background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 20px; margin-top: 15px; cursor: pointer; width: 100%;">
                        💾 Save Feedback
                    </button>
                </div>
            </div>
            
            <div class="feedback-list">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Session Summary:</h3>
                <div id="feedbackList"></div>
                <button class="clear-btn" onclick="clearAllFeedback()">Clear All Data</button>
            </div>
            
            <div class="export-section">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">📁 Export</h3>
                <button class="export-btn" onclick="exportCSV()">📁 Download CSV</button>
            </div>
        </div>
    </div>

<script>
let selectedPlayer = null;
let mediaRecorder = null;
let recordedChunks = [];
let feedbackData = [];
let attendanceData = new Set();
let currentFeedback = {};

// Set today's date
document.getElementById('sessionDate').valueAsDate = new Date();

// Attendance tracking
document.querySelectorAll('.attendance-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const playerName = btn.dataset.player;
        
        if (attendanceData.has(playerName)) {
            attendanceData.delete(playerName);
            btn.classList.remove('present');
            btn.querySelector('.attendance-badge').style.display = 'none';
        } else {
            attendanceData.add(playerName);
            btn.classList.add('present');
            btn.querySelector('.attendance-badge').style.display = 'flex';
        }
        
        displayFeedback(feedbackData);
    });
});

// Feedback selection
document.querySelectorAll('.feedback-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedPlayer = btn.dataset.player;
        
        document.getElementById('feedbackCategories').style.display = 'block';
        document.getElementById('selectedPlayerName').textContent = selectedPlayer;
        
        currentFeedback = {};
        document.getElementById('overallRating').value = '';
        document.getElementById('specialMention').checked = false;
        document.getElementById('playerOfSession').checked = false;
        document.getElementById('feedbackStatus').textContent = '';
    });
});

// Recording
document.querySelectorAll('.record-mini-btn').forEach(btn => {
    btn.addEventListener('mousedown', () => startRecording(btn));
    btn.addEventListener('mouseup', () => stopRecording(btn));
    btn.addEventListener('touchstart', () => startRecording(btn));
    btn.addEventListener('touchend', () => stopRecording(btn));
});

async function startRecording(btn) {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Use webm format for better browser compatibility
        const options = { mimeType: 'audio/webm' };
        if (!MediaRecorder.isTypeSupported('audio/webm')) {
            options.mimeType = 'audio/mp4';
        }
        if (!MediaRecorder.isTypeSupported('audio/mp4')) {
            options.mimeType = '';
        }
        
        mediaRecorder = new MediaRecorder(stream, options);
        recordedChunks = [];

        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };

        mediaRecorder.onstop = () => {
            const mimeType = mediaRecorder.mimeType || 'audio/webm';
            const blob = new Blob(recordedChunks, { type: mimeType });
            const audioUrl = URL.createObjectURL(blob);
            
            console.log('Recording completed:');
            console.log('- MIME type:', mimeType);
            console.log('- Blob size:', blob.size);
            console.log('- Audio URL:', audioUrl);
            
            currentFeedback.feedback = audioUrl;
            document.getElementById('feedbackStatus').textContent = '✅ Recorded (' + mimeType + ')';
            btn.classList.remove('recording');
            
            stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        btn.classList.add('recording');
        document.getElementById('feedbackStatus').textContent = '🔴 Recording...';

    } catch (error) {
        console.error('Recording error:', error);
        document.getElementById('feedbackStatus').textContent = 'Error: Cannot access microphone';
    }
}

function stopRecording(btn) {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
    }
}

function saveFeedback() {
    if (!selectedPlayer) return;
    
    const feedback = {
        player: selectedPlayer,
        sessionDate: document.getElementById('sessionDate').value || new Date().toISOString().split('T')[0],
        team: document.getElementById('teamSelect').value || 'Not specified',
        location: document.getElementById('locationSelect').value || 'Not specified',
        attended: attendanceData.has(selectedPlayer),
        overallRating: document.getElementById('overallRating').value || 'Not rated',
        feedback: currentFeedback.feedback || null,
        specialMention: document.getElementById('specialMention').checked,
        playerOfSession: document.getElementById('playerOfSession').checked,
        timestamp: new Date().toLocaleString(),
        id: Date.now()
    };
    
    feedbackData.push(feedback);
    displayFeedback(feedbackData);
    
    document.getElementById('feedbackCategories').style.display = 'none';
    document.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('selected'));
    selectedPlayer = null;
    
    alert(`Feedback saved for ${feedback.player}!`);
}

function displayFeedback(feedback) {
    const list = document.getElementById('feedbackList');
    list.innerHTML = '';

    if (feedback.length === 0) {
        list.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 20px;">No feedback recorded yet</p>';
        return;
    }

    feedback.slice(-10).reverse().forEach(item => {
        const badges = [];
        if (item.specialMention) badges.push('🏆 Special Mention');
        if (item.playerOfSession) badges.push('⭐ Player of Session');
        
        const div = document.createElement('div');
        div.className = 'feedback-item';
        div.innerHTML = `
            <div class="feedback-header">
                <span class="player-name">${item.player}</span>
                <span class="timestamp">${item.sessionDate}</span>
            </div>
            <div style="font-size: 12px; color: #7f8c8d; margin: 5px 0;">
                ${item.attended ? '✅ Present' : '❌ Absent'} • Rating: ${item.overallRating}
            </div>
            ${badges.length > 0 ? `<div style="margin: 5px 0; font-size: 12px;">${badges.join(' • ')}</div>` : ''}
            <div style="margin: 10px 0;">
                ${item.feedback ? `<button class="play-btn" onclick="playAudio(event, '${item.feedback}')">▶️ Play Feedback</button>` : ''}
            </div>
        `;
        list.appendChild(div);
    });

    // Show summary
    const attendanceCount = attendanceData.size;
    const feedbackCount = feedback.length;
    const summary = document.createElement('div');
    summary.style.cssText = 'background: #3498db; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-size: 14px;';
    summary.innerHTML = `📊 ${attendanceCount} players present • ${feedbackCount} feedback recorded`;
    list.insertBefore(summary, list.firstChild);
}

function playAudio(event, url) {
    // Prevent any default behavior
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    console.log('Attempting to play audio:', url);
    
    try {
        const audio = new Audio();
        audio.src = url;
        audio.preload = 'auto';
        
        // Add event listeners for debugging
        audio.addEventListener('loadstart', () => console.log('Audio: Load started'));
        audio.addEventListener('canplay', () => console.log('Audio: Can play'));
        audio.addEventListener('error', (e) => {
            console.error('Audio error:', e);
            console.error('Audio error details:', audio.error);
            alert(`Audio error: ${audio.error ? audio.error.message : 'Unknown error'}`);
        });
        
        // Force load the audio
        audio.load();
        
        // Try to play immediately
        const playPromise = audio.play();
        
        if (playPromise !== undefined) {
            playPromise
                .then(() => {
                    console.log('✅ Audio playing successfully');
                })
                .catch(error => {
                    console.error('❌ Play failed:', error);
                    
                    // Try alternative approach
                    setTimeout(() => {
                        try {
                            audio.currentTime = 0;
                            audio.play().catch(e => {
                                console.error('Retry failed:', e);
                                alert('Cannot play audio. This might be a browser limitation. Try refreshing the page and recording again.');
                            });
                        } catch (retryError) {
                            console.error('Retry attempt failed:', retryError);
                        }
                    }, 100);
                });
        }
        
    } catch (error) {
        console.error('Audio creation error:', error);
        alert('Cannot create audio player. Browser may not support this audio format.');
    }
}

function clearAllFeedback() {
    if (confirm('Clear all session data? This cannot be undone.')) {
        feedbackData = [];
        attendanceData.clear();
        document.querySelectorAll('.attendance-btn').forEach(btn => {
            btn.classList.remove('present');
            btn.querySelector('.attendance-badge').style.display = 'none';
        });
        document.querySelectorAll('.feedback-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        document.getElementById('feedbackCategories').style.display = 'none';
        selectedPlayer = null;
        displayFeedback([]);
    }
}

function exportCSV() {
    const headers = ['Date', 'Player', 'Team', 'Location', 'Attended', 'Overall Rating', 'Special Mention', 'Player of Session', 'Has Audio', 'Timestamp'];
    const rows = feedbackData.map(f => [
        f.sessionDate,
        f.player,
        f.team,
        f.location,
        f.attended ? 'Yes' : 'No',
        f.overallRating,
        f.specialMention ? 'Yes' : 'No',
        f.playerOfSession ? 'Yes' : 'No',
        f.feedback ? 'Yes' : 'No',
        f.timestamp
    ]);
    
    const sessionDate = document.getElementById('sessionDate').value || new Date().toISOString().split('T')[0];
    attendanceData.forEach(player => {
        if (!feedbackData.some(f => f.player === player)) {
            rows.push([
                sessionDate,
                player,
                document.getElementById('teamSelect').value || 'Not specified',
                document.getElementById('locationSelect').value || 'Not specified',
                'Yes',
                'No feedback given',
                'No',
                'No',
                'No',
                new Date().toLocaleString()
            ]);
        }
    });
    
    if (rows.length === 0) {
        alert('No session data to export. Please record some feedback first.');
        return;
    }
    
    const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `training_session_${sessionDate}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    alert(`Session data exported!`);
}

// Initialize
displayFeedback([]);
</script>
</body>
</html>
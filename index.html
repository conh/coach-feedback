<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Feedback App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d5a3d 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        @media (min-width: 480px) {
            .container {
                max-width: 420px;
            }
        }
        
        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d5a3d 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
        }
        
        .logo {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            position: relative;
        }
        
        .logo svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            color: #00ff88;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
            color: #b8e6d0;
        }
        
        .main {
            padding: 20px 15px;
        }
        
        .player-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .workflow-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f0f8f4;
            border-radius: 15px;
            border: 2px solid #e6f7ed;
        }
        
        .player-btn {
            background: #f8f9fa;
            border: 2px solid #2d5a3d;
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            position: relative;
        }
        
        .player-btn:hover {
            background: #2d5a3d;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(45, 90, 61, 0.3);
        }
        
        .feedback-btn.has-feedback {
            background: #2d5a3d;
            color: white;
            border-color: #2d5a3d;
        }
        
        .feedback-btn.selected {
            background: #00ff88;
            color: #1a1a1a;
            border-color: #00ff88;
            font-weight: bold;
        }
        
        .attendance-btn.present {
            background: #2d5a3d;
            color: white;
            border-color: #2d5a3d;
        }
        
        .attendance-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #00ff88;
            color: #1a1a1a;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .session-setup {
            background: #f0f8f4;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #e6f7ed;
        }
        
        .export-section {
            background: linear-gradient(135deg, #2d5a3d 0%, #1a1a1a 100%);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
        }
        
        .export-section h3 {
            color: #00ff88;
            margin-bottom: 15px;
        }
        
        .export-btn {
            background: #00ff88;
            color: #1a1a1a;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: #00e67a;
            transform: scale(1.05);
        }
        
        .category-section {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #2d5a3d;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .record-mini-btn {
            background: #00ff88;
            color: #1a1a1a;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            display: inline-block;
            margin: 5px 0;
            font-size: 14px;
            user-select: none;
            border: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .record-mini-btn:hover {
            background: #00e67a;
            transform: scale(1.05);
        }
        
        .record-mini-btn.recording {
            background: #ff4757;
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        .audio-status {
            font-size: 12px;
            color: #2d5a3d;
            margin: 5px 0;
            font-weight: 600;
        }
        
        .feedback-categories {
            background: #f0f8f4;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #e6f7ed;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .feedback-list {
            margin-top: 30px;
        }
        
        .feedback-item {
            background: #f0f8f4;
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #2d5a3d;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .player-name {
            font-weight: bold;
            color: #1a1a1a;
        }
        
        .timestamp {
            font-size: 12px;
            color: #2d5a3d;
            font-weight: 600;
        }
        
        .play-btn {
            background: #2d5a3d;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
            transition: all 0.3s ease;
        }
        
        .play-btn:hover {
            background: #1a1a1a;
            transform: scale(1.05);
        }
        
        .clear-btn {
            background: #1a1a1a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .clear-btn:hover {
            background: #333;
        }
        
        select, input[type="date"], input[type="text"] {
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #2d5a3d;
            background: white;
            color: #1a1a1a;
            font-weight: 600;
        }
        
        select:focus, input[type="date"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }
        
        .workflow-section h3, .session-setup h3, .feedback-list h3 {
            color: #1a1a1a;
            margin-bottom: 15px;
        }
        
        .save-feedback-btn {
            background: #2d5a3d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            margin-top: 15px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .save-feedback-btn:hover {
            background: #1a1a1a;
            transform: scale(1.02);
        }
        
        .summary-stats {
            background: linear-gradient(135deg, #2d5a3d 0%, #1a1a1a 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
        }
        
        .summary-stats .highlight {
            color: #00ff88;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <!-- Outer Green Ring -->
                    <circle cx="50" cy="50" r="48" fill="#2d5a3d" stroke="#ffffff" stroke-width="1"/>
                    
                    <!-- Inner White Circle -->
                    <circle cx="50" cy="50" r="35" fill="#ffffff" stroke="#2d5a3d" stroke-width="1"/>
                    
                    <!-- Player Silhouette -->
                    <g transform="translate(50, 50) scale(0.8)">
                        <!-- Head -->
                        <ellipse cx="0" cy="-15" rx="4" ry="5" fill="#1a1a1a"/>
                        
                        <!-- Body -->
                        <ellipse cx="0" cy="-5" rx="6" ry="8" fill="#1a1a1a"/>
                        
                        <!-- Left Arm -->
                        <ellipse cx="-8" cy="-8" rx="2.5" ry="6" fill="#1a1a1a" transform="rotate(-30)"/>
                        
                        <!-- Right Arm -->
                        <ellipse cx="8" cy="-8" rx="2.5" ry="6" fill="#1a1a1a" transform="rotate(30)"/>
                        
                        <!-- Left Leg -->
                        <ellipse cx="-3" cy="8" rx="2.5" ry="8" fill="#1a1a1a" transform="rotate(-15)"/>
                        
                        <!-- Right Leg (kicking) -->
                        <ellipse cx="5" cy="5" rx="2.5" ry="8" fill="#1a1a1a" transform="rotate(45)"/>
                        
                        <!-- Ball -->
                        <circle cx="12" cy="2" r="3" fill="#1a1a1a"/>
                        <circle cx="12" cy="2" r="3" fill="none" stroke="#ffffff" stroke-width="0.5"/>
                        <path d="M10,2 L14,2 M12,0 L12,4" stroke="#ffffff" stroke-width="0.5"/>
                    </g>
                    
                    <!-- Top Text -->
                    <path id="topArc" d="M 15 50 A 35 35 0 0 1 85 50" fill="none"/>
                    <text font-size="6" font-weight="bold" fill="#ffffff">
                        <textPath href="#topArc" startOffset="50%" text-anchor="middle">ROEHAMPTON ELITE</textPath>
                    </text>
                    
                    <!-- Bottom Text -->
                    <path id="bottomArc" d="M 85 50 A 35 35 0 0 1 15 50" fill="none"/>
                    <text font-size="6" font-weight="bold" fill="#ffffff">
                        <textPath href="#bottomArc" startOffset="50%" text-anchor="middle">FOOTBALL CLUB</textPath>
                    </text>
                    
                    <!-- Year Numbers -->
                    <text x="18" y="55" font-size="5" font-weight="bold" fill="#ffffff">20</text>
                    <text x="78" y="55" font-size="5" font-weight="bold" fill="#ffffff">24</text>
                </svg>
            </div>
            <h1>⚽ Training Feedback</h1>
            <p>Roehampton Elite FC</p>
        </div>

        <div class="main">
            <div class="session-setup">
                <h3 style="margin-bottom: 15px; color: #1a1a1a;">Session Details:</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <input type="date" id="sessionDate" style="width: 100%;">
                    <select id="coachSelect">
                        <option value="">Coach</option>
                        <option value="Coach Smith">Coach Smith</option>
                        <option value="Coach Johnson">Coach Johnson</option>
                        <option value="Coach Williams">Coach Williams</option>
                        <option value="Coach Brown">Coach Brown</option>
                        <option value="Coach Davis">Coach Davis</option>
                        <option value="Coach Miller">Coach Miller</option>
                        <option value="Coach Wilson">Coach Wilson</option>
                        <option value="Coach Moore">Coach Moore</option>
                        <option value="Coach Taylor">Coach Taylor</option>
                        <option value="Coach Anderson">Coach Anderson</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <select id="squadSelect">
                        <option value="">Squad</option>
                        <option value="Pre Academy">Pre Academy</option>
                        <option value="Development">Development</option>
                        <option value="Elite">Elite</option>
                    </select>
                    <select id="teamSelect">
                        <option value="">Team</option>
                        <option value="Team A">Team A</option>
                        <option value="Team B">Team B</option>
                        <option value="Team C">Team C</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <select id="ageGroupSelect">
                        <option value="">Age Group</option>
                        <option value="U6">U6</option>
                        <option value="U7">U7</option>
                        <option value="U8">U8</option>
                        <option value="U9">U9</option>
                        <option value="U10">U10</option>
                        <option value="U11">U11</option>
                        <option value="U12">U12</option>
                        <option value="U13">U13</option>
                        <option value="U14">U14</option>
                        <option value="U15">U15</option>
                        <option value="U16">U16</option>
                        <option value="U17">U17</option>
                        <option value="U18">U18</option>
                    </select>
                    <select id="locationSelect">
                        <option value="">Location</option>
                        <option value="Richmond Park Academy">Richmond Park Academy</option>
                        <option value="St Paul's School">St Paul's School</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <h3 style="margin-bottom: 8px; color: #1a1a1a; font-size: 16px;">Session Themes:</h3>
                    <p style="font-size: 12px; color: #2d5a3d; margin-bottom: 15px; font-weight: 600;">(select all that apply)</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <input type="checkbox" name="sessionTheme" value="Rondos"> Rondos
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <input type="checkbox" name="sessionTheme" value="1v1 Situations"> 1v1 Situations
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <input type="checkbox" name="sessionTheme" value="2v2/3v3 and More Situations, Including Overloads"> 2v2/3v3 & Overloads
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <input type="checkbox" name="sessionTheme" value="Passing & Receiving"> Passing & Receiving
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <input type="checkbox" name="sessionTheme" value="Dribbling & Ball Control"> Dribbling & Ball Control
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <input type="checkbox" name="sessionTheme" value="Shooting & Finishing"> Shooting & Finishing
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <input type="checkbox" name="sessionTheme" value="Defending"> Defending
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <input type="checkbox" name="sessionTheme" value="Attacking"> Attacking
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <input type="checkbox" name="sessionTheme" value="Possession"> Possession
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <input type="checkbox" name="sessionTheme" value="Small Sided Games"> Small Sided Games
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <input type="checkbox" name="sessionTheme" value="Match Preparation"> Match Preparation
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <input type="checkbox" name="sessionTheme" value="Speed & Agility"> Speed & Agility
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <input type="checkbox" name="sessionTheme" value="Set Pieces"> Set Pieces
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <input type="checkbox" name="sessionTheme" value="Mini Tournament"> Mini Tournament
                        </label>
                    </div>
                    <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <input type="checkbox" id="sessionThemeOther" onchange="toggleOtherSessionTheme()"> Other
                    </label>
                    <input type="text" id="sessionThemeOtherText" placeholder="Please specify other session theme(s)" 
                           style="width: 100%; padding: 8px; border-radius: 5px; border: 2px solid #2d5a3d; display: none;">
                </div>
            </div>
            
            <div class="workflow-section">
                <h3 style="margin-bottom: 15px; color: #1a1a1a;">Step 1: Mark Attendance</h3>
                <div class="player-grid">
                    <button class="player-btn attendance-btn" data-player="Jake Smith">
                        Jake Smith
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Mike Johnson">
                        Mike Johnson
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Sam Wilson">
                        Sam Wilson
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Tom Brown">
                        Tom Brown
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Alex Davis">
                        Alex Davis
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Ryan Miller">
                        Ryan Miller
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                </div>
            </div>
            
            <div class="workflow-section">
                <h3 style="margin-bottom: 15px; color: #1a1a1a;">Step 2: Record Player Feedback</h3>
                <div class="player-grid">
                    <button class="player-btn feedback-btn" data-player="Jake Smith">
                        Jake Smith
                        <div class="feedback-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn feedback-btn" data-player="Mike Johnson">
                        Mike Johnson
                        <div class="feedback-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn feedback-btn" data-player="Sam Wilson">
                        Sam Wilson
                        <div class="feedback-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn feedback-btn" data-player="Tom Brown">
                        Tom Brown
                        <div class="feedback-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn feedback-btn" data-player="Alex Davis">
                        Alex Davis
                        <div class="feedback-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn feedback-btn" data-player="Ryan Miller">
                        Ryan Miller
                        <div class="feedback-badge" style="display: none;">✓</div>
                    </button>
                </div>
                
                <div class="feedback-categories" id="feedbackCategories" style="display: none;">
                    <h4 style="margin: 20px 0 10px 0; color: #1a1a1a;">Feedback for <span id="selectedPlayerName"></span>:</h4>
                    
                    <div class="category-section">
                        <label style="font-weight: bold; color: #1a1a1a;">⭐ Overall Performance:</label>
                        <select id="overallRating" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 5px; border: 2px solid #2d5a3d;">
                            <option value="">Select rating</option>
                            <option value="Excellent">Excellent</option>
                            <option value="Very Good">Very Good</option>
                            <option value="Good">Good</option>
                            <option value="Average">Average</option>
                            <option value="Needs Improvement">Needs Improvement</option>
                        </select>
                    </div>
                    
                    <div class="category-section">
                        <label style="font-weight: bold; color: #2d5a3d;">🎤 Voice Feedback:</label>
                        <p style="font-size: 12px; color: #2d5a3d; margin: 5px 0;">Hold button and speak clearly for at least 2 seconds</p>
                        <button class="record-mini-btn" data-category="feedback">🎤 Record</button>
                        <div class="audio-status" id="feedbackStatus"></div>
                    </div>
                    
                    <div class="category-section">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <label style="font-weight: bold; color: #2d5a3d;">🏆 Special mentions:</label>
                        </div>
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <label style="font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="specialMention"> Special mention
                            </label>
                            <label style="font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="playerOfSession"> Player of session
                            </label>
                        </div>
                    </div>
                    
                    <button onclick="saveFeedback()" class="save-feedback-btn">
                        💾 Save Feedback
                    </button>
                </div>
            </div>
            
            <div class="feedback-list">
                <h3 style="margin-bottom: 15px; color: #1a1a1a;">Session Summary:</h3>
                <div id="feedbackList"></div>
                <button class="clear-btn" onclick="clearAllFeedback()">Clear All Data</button>
            </div>
            
            <div class="export-section">
                <h3 style="margin-bottom: 15px; color: #00ff88;">📁 Export</h3>
                <button class="export-btn" onclick="exportCSV()">📁 Download CSV</button>
                <button class="export-btn" onclick="downloadAllAudioFiles()">🎤 Download All Audio</button>
            </div>
        </div>
    </div>

<script>
let selectedPlayer = null;
let mediaRecorder = null;
let recordedChunks = [];
let feedbackData = [];
let attendanceData = new Set();
let currentFeedback = {};

// Set today's date
document.getElementById('sessionDate').valueAsDate = new Date();

// Handle session theme checkboxes
function toggleOtherSessionTheme() {
    const otherCheckbox = document.getElementById('sessionThemeOther');
    const otherText = document.getElementById('sessionThemeOtherText');
    
    if (otherCheckbox.checked) {
        otherText.style.display = 'block';
        otherText.focus();
    } else {
        otherText.style.display = 'none';
        otherText.value = '';
    }
}

// Get the session themes as comma-separated string
function getSessionThemes() {
    const checkboxes = document.querySelectorAll('input[name="sessionTheme"]:checked');
    const themes = Array.from(checkboxes).map(cb => cb.value);
    
    // Add "Other" text if specified
    const otherCheckbox = document.getElementById('sessionThemeOther');
    const otherText = document.getElementById('sessionThemeOtherText').value.trim();
    if (otherCheckbox.checked && otherText) {
        themes.push(otherText);
    }
    
    return themes.length > 0 ? themes.join(', ') : 'Not specified';
}

// Attendance tracking
document.querySelectorAll('.attendance-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const playerName = btn.dataset.player;
        
        if (attendanceData.has(playerName)) {
            attendanceData.delete(playerName);
            btn.classList.remove('present');
            btn.querySelector('.attendance-badge').style.display = 'none';
        } else {
            attendanceData.add(playerName);
            btn.classList.add('present');
            btn.querySelector('.attendance-badge').style.display = 'flex';
        }
        
        displayFeedback(feedbackData);
    });
});

// Feedback selection
document.querySelectorAll('.feedback-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedPlayer = btn.dataset.player;
        
        document.getElementById('feedbackCategories').style.display = 'block';
        document.getElementById('selectedPlayerName').textContent = selectedPlayer;
        
        currentFeedback = {};
        document.getElementById('overallRating').value = '';
        document.getElementById('specialMention').checked = false;
        document.getElementById('playerOfSession').checked = false;
        document.getElementById('feedbackStatus').textContent = '';
    });
});

// Recording
document.querySelectorAll('.record-mini-btn').forEach(btn => {
    btn.addEventListener('mousedown', (e) => {
        e.preventDefault();
        startRecording(btn);
    });
    btn.addEventListener('mouseup', (e) => {
        e.preventDefault();
        stopRecording(btn);
    });
    btn.addEventListener('mouseleave', (e) => {
        e.preventDefault();
        stopRecording(btn);
    });
    btn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startRecording(btn);
    });
    btn.addEventListener('touchend', (e) => {
        e.preventDefault();
        stopRecording(btn);
    });
    btn.addEventListener('touchcancel', (e) => {
        e.preventDefault();
        stopRecording(btn);
    });
});

async function startRecording(btn) {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        return; // Already recording
    }
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
                sampleRate: 44100
            }
        });
        
        // Use MP4 format for maximum compatibility
        let options = { 
            mimeType: 'audio/mp4',
            audioBitsPerSecond: 128000
        };
        if (!MediaRecorder.isTypeSupported('audio/mp4')) {
            options = { 
                mimeType: 'audio/webm;codecs=opus',
                audioBitsPerSecond: 128000
            };
        }
        if (!MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
            options = { mimeType: 'audio/webm' };
        }
        
        mediaRecorder = new MediaRecorder(stream, options);
        recordedChunks = [];
        let recordingStartTime = Date.now();
        
        // Store the stream and start time for later use
        mediaRecorder.stream = stream;
        mediaRecorder.startTime = recordingStartTime;

        mediaRecorder.ondataavailable = (event) => {
            console.log('Data available:', event.data.size, 'bytes');
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };

        mediaRecorder.onstop = () => {
            const recordingDuration = Date.now() - recordingStartTime;
            console.log('Recording stopped. Duration:', recordingDuration, 'ms');
            console.log('Total chunks:', recordedChunks.length);
            
            // Clean up the stream
            if (mediaRecorder.stream) {
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            
            if (recordedChunks.length === 0) {
                document.getElementById('feedbackStatus').textContent = '❌ No audio data recorded';
                return;
            }
            
            // Ensure minimum recording duration
            if (recordingDuration < 500) {
                document.getElementById('feedbackStatus').textContent = '❌ Recording too short - hold button longer';
                return;
            }
            
            const mimeType = mediaRecorder.mimeType || 'audio/webm';
            const blob = new Blob(recordedChunks, { type: mimeType });
            
            console.log('Final blob size:', blob.size, 'bytes');
            console.log('MIME type:', mimeType);
            
            if (blob.size === 0) {
                document.getElementById('feedbackStatus').textContent = '❌ Empty recording - try again';
                return;
            }
            
            // Create filename for the audio
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `feedback_${selectedPlayer.replace(/\s+/g, '_')}_${timestamp}`;
            
            // Determine file extension based on MIME type
            let extension = '.m4a';
            if (mimeType.includes('mp4')) {
                extension = '.m4a';
            } else if (mimeType.includes('webm')) {
                extension = '.webm';
            } else if (mimeType.includes('wav')) {
                extension = '.wav';
            }
            
            // Store the audio data
            currentFeedback.feedback = {
                blob: blob,
                filename: filename + extension,
                mimeType: mimeType,
                hasAudio: true,
                duration: recordingDuration
            };
            
            console.log('Recording saved:', filename + extension);
            
            document.getElementById('feedbackStatus').textContent = `✅ Recorded ${(recordingDuration/1000).toFixed(1)}s ${extension.toUpperCase()} file`;
            btn.classList.remove('recording');
        };

        mediaRecorder.onerror = (event) => {
            console.error('MediaRecorder error:', event.error);
            document.getElementById('feedbackStatus').textContent = '❌ Recording error';
            if (mediaRecorder.stream) {
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        };

        // Start recording with timeslice for continuous data capture
        mediaRecorder.start(250); // Capture data every 250ms
        btn.classList.add('recording');
        document.getElementById('feedbackStatus').textContent = '🔴 Recording... (hold and speak clearly)';
        
        console.log('Recording started with options:', options);

    } catch (error) {
        console.error('Recording error:', error);
        document.getElementById('feedbackStatus').textContent = 'Error: Cannot access microphone - check permissions';
    }
}

function stopRecording(btn) {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        console.log('Stopping recording...');
        mediaRecorder.stop();
        btn.classList.remove('recording');
    } else {
        console.log('MediaRecorder not recording, state:', mediaRecorder ? mediaRecorder.state : 'null');
    }
}

function saveFeedback() {
    if (!selectedPlayer) return;
    
    const feedback = {
        player: selectedPlayer,
        coach: document.getElementById('coachSelect').value || 'Not specified',
        sessionDate: document.getElementById('sessionDate').value || new Date().toISOString().split('T')[0],
        squad: document.getElementById('squadSelect').value || 'Not specified',
        team: document.getElementById('teamSelect').value || 'Not specified',
        ageGroup: document.getElementById('ageGroupSelect').value || 'Not specified',
        location: document.getElementById('locationSelect').value || 'Not specified',
        sessionThemes: getSessionThemes(),
        attended: attendanceData.has(selectedPlayer),
        overallRating: document.getElementById('overallRating').value || 'Not rated',
        feedback: currentFeedback.feedback || null,
        specialMention: document.getElementById('specialMention').checked,
        playerOfSession: document.getElementById('playerOfSession').checked,
        timestamp: new Date().toLocaleString(),
        id: Date.now()
    };
    
    feedbackData.push(feedback);
    
    // Mark the player as having feedback with visual indicator
    const playerBtn = document.querySelector(`.feedback-btn[data-player="${selectedPlayer}"]`);
    if (playerBtn) {
        playerBtn.classList.add('has-feedback');
        const badge = playerBtn.querySelector('.feedback-badge');
        if (badge) {
            badge.style.display = 'flex';
        }
    }
    
    displayFeedback(feedbackData);
    
    document.getElementById('feedbackCategories').style.display = 'none';
    document.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('selected'));
    selectedPlayer = null;
    
    alert(`Feedback saved for ${feedback.player}!`);
}

function displayFeedback(feedback) {
    const list = document.getElementById('feedbackList');
    list.innerHTML = '';

    if (feedback.length === 0) {
        list.innerHTML = '<p style="color: #2d5a3d; text-align: center; padding: 20px;">No feedback recorded yet</p>';
        return;
    }

    feedback.slice(-10).reverse().forEach(item => {
        const badges = [];
        if (item.specialMention) badges.push('🏆 Special Mention');
        if (item.playerOfSession) badges.push('⭐ Player of Session');
        
        const div = document.createElement('div');
        div.className = 'feedback-item';
        div.innerHTML = `
            <div class="feedback-header">
                <span class="player-name">${item.player}</span>
                <span class="timestamp">${item.sessionDate}</span>
            </div>
            <div style="font-size: 12px; color: #2d5a3d; margin: 5px 0; font-weight: 600;">
                ${item.attended ? '✅ Present' : '❌ Absent'} • Rating: ${item.overallRating}<br>
                Coach: ${item.coach} • Squad: ${item.squad} • Team: ${item.team} • Age: ${item.ageGroup}<br>
                Themes: ${item.sessionThemes || 'Not specified'}
            </div>
            ${badges.length > 0 ? `<div style="margin: 5px 0; font-size: 12px; color: #1a1a1a; font-weight: bold;">${badges.join(' • ')}</div>` : ''}
            <div style="margin: 10px 0;">
                ${item.feedback && item.feedback.hasAudio ? `<button class="play-btn" onclick="downloadAudio('${item.feedback.filename}', '${item.id}')">📁 Download ${item.feedback.filename.split('.').pop().toUpperCase()}</button>` : ''}
            </div>
        `;
        list.appendChild(div);
    });

    // Show summary
    const attendanceCount = attendanceData.size;
    const feedbackCount = feedback.length;
    const summary = document.createElement('div');
    summary.className = 'summary-stats';
    summary.innerHTML = `📊 <span class="highlight">${attendanceCount}</span> players present • <span class="highlight">${feedbackCount}</span> feedback recorded`;
    list.insertBefore(summary, list.firstChild);
}

function downloadAudio(filename, feedbackId) {
    // Find the feedback item with this ID
    const feedback = feedbackData.find(f => f.id == feedbackId);
    if (!feedback || !feedback.feedback) {
        alert('Audio file not found');
        return;
    }
    
    try {
        const audioData = feedback.feedback;
        
        // Create download link
        const url = URL.createObjectURL(audioData.blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = audioData.filename; // Already has correct extension
        a.style.display = 'none';
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // Clean up the URL
        setTimeout(() => URL.revokeObjectURL(url), 100);
        
        console.log('Audio download initiated:', audioData.filename);
        
    } catch (error) {
        console.error('Download error:', error);
        alert('Could not download audio file');
    }
}

function downloadAllAudioFiles() {
    const audioFiles = feedbackData.filter(f => f.feedback);
    
    if (audioFiles.length === 0) {
        alert('No audio recordings to download');
        return;
    }
    
    alert(`Downloading ${audioFiles.length} audio files. They will download one by one.`);
    
    // Download each audio file with a small delay
    audioFiles.forEach((feedback, index) => {
        setTimeout(() => {
            downloadAudio(feedback.feedback.filename, feedback.id);
        }, index * 500); // 500ms delay between downloads
    });
}

function clearAllFeedback() {
    if (confirm('Clear all session data? This cannot be undone.')) {
        feedbackData = [];
        attendanceData.clear();
        document.querySelectorAll('.attendance-btn').forEach(btn => {
            btn.classList.remove('present');
            btn.querySelector('.attendance-badge').style.display = 'none';
        });
        document.querySelectorAll('.feedback-btn').forEach(btn => {
            btn.classList.remove('selected', 'has-feedback');
            const badge = btn.querySelector('.feedback-badge');
            if (badge) {
                badge.style.display = 'none';
            }
        });
        document.getElementById('feedbackCategories').style.display = 'none';
        selectedPlayer = null;
        displayFeedback([]);
    }
}

function exportCSV() {
    const headers = ['Date', 'Coach', 'Player', 'Squad', 'Team', 'Age Group', 'Location', 'Session Themes', 'Attended', 'Overall Rating', 'Special Mention', 'Player of Session', 'Has Audio', 'Audio Filename', 'Timestamp'];
    const rows = feedbackData.map(f => [
        f.sessionDate,
        f.coach,
        f.player,
        f.squad,
        f.team,
        f.ageGroup,
        f.location,
        f.sessionThemes,
        f.attended ? 'Yes' : 'No',
        f.overallRating,
        f.specialMention ? 'Yes' : 'No',
        f.playerOfSession ? 'Yes' : 'No',
        (f.feedback && f.feedback.hasAudio) ? 'Yes' : 'No',
        (f.feedback && f.feedback.hasAudio) ? f.feedback.filename : 'No audio',
        f.timestamp
    ]);
    
    const sessionDate = document.getElementById('sessionDate').value || new Date().toISOString().split('T')[0];
    attendanceData.forEach(player => {
        if (!feedbackData.some(f => f.player === player)) {
            rows.push([
                sessionDate,
                document.getElementById('coachSelect').value || 'Not specified',
                player,
                document.getElementById('squadSelect').value || 'Not specified',
                document.getElementById('teamSelect').value || 'Not specified',
                document.getElementById('ageGroupSelect').value || 'Not specified',
                document.getElementById('locationSelect').value || 'Not specified',
                getSessionThemes(),
                'Yes',
                'No feedback given',
                'No',
                'No',
                'No',
                'No audio',
                new Date().toLocaleString()
            ]);
        }
    });
    
    if (rows.length === 0) {
        alert('No session data to export. Please record some feedback first.');
        return;
    }
    
    const csvContent = [headers, ...rows].map(row => row.map(cell => 
        // Escape commas in cell content
        typeof cell === 'string' && cell.includes(',') ? `"${cell}"` : cell
    ).join(',')).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `training_session_${sessionDate}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    alert(`Session data exported with ${feedbackData.filter(f => f.feedback && f.feedback.hasAudio).length} audio files referenced!`);
}

// Initialize
displayFeedback([]);
</script>
</body>
</html>
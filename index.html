<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Feedback - Google Forms Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 25px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .main {
            padding: 30px 20px;
        }
        
        .player-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .workflow-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .player-btn {
            background: #ecf0f1;
            border: none;
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            position: relative;
        }
        
        .player-btn:hover {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
        }
        
        .feedback-btn.selected {
            background: #e74c3c;
            color: white;
        }
        
        .attendance-btn.present {
            background: #27ae60;
            color: white;
        }
        
        .attendance-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #27ae60;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .session-setup {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }
        
        .sheets-config {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }
        
        .sheets-config.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }
        
        .export-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
        }
        
        .export-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 5px;
        }
        
        .export-btn:hover {
            background: #219a52;
        }
        
        .export-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .data-preview {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #bdc3c7;
        }
        
        .category-section {
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .record-mini-btn {
            background: #e74c3c;
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            display: inline-block;
            margin: 5px 0;
            font-size: 14px;
            user-select: none;
            border: none;
        }
        
        .record-mini-btn:hover {
            background: #c0392b;
        }
        
        .record-mini-btn.recording {
            background: #27ae60;
            animation: pulse 1.5s infinite;
        }
        
        .audio-status {
            font-size: 12px;
            color: #7f8c8d;
            margin: 5px 0;
        }
        
        .feedback-categories {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .feedback-list {
            margin-top: 30px;
        }
        
        .feedback-item {
            background: #ecf0f1;
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .player-name {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .timestamp {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .play-btn {
            background: #3498db;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .play-btn:hover {
            background: #2980b9;
        }
        
        .clear-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }
        
        .warning {
            background: #f39c12;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }
        
        .success {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
            text-align: center;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
            text-align: center;
        }
        
        .sync-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-size: 14px;
        }
        
        .sync-status.syncing {
            background: #3498db;
            color: white;
        }
        
        .sync-status.success {
            background: #27ae60;
            color: white;
        }
        
        .sync-status.error {
            background: #e74c3c;
            color: white;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #bdc3c7;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öΩ Football Coach Feedback</h1>
            <p>Record player feedback with Google Sheets sync</p>
        </div>

        <div class="main">
            <div class="sheets-config" id="sheetsConfig">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">üìä Google Forms Integration</h3>
                <div class="success" style="text-align: center;">
                    ‚úÖ Connected to Google Forms!<br>
                    Data will automatically save to your Google Sheet when you record feedback.
                </div>
                <button class="export-btn" onclick="testFormsConnection()">üß™ Test Connection</button>
                <div id="connectionStatus" class="sync-status" style="display: none;"></div>
            </div>

            <div class="warning">
                üì± Audio recordings are stored locally. For production, they'd be uploaded to cloud storage with links in the sheet.
            </div>
            
            <div class="session-setup">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Session Setup:</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <select id="clubSelect" style="padding: 10px; border-radius: 8px; border: 1px solid #bdc3c7;">
                        <option value="">Select Club</option>
                        <option value="City FC">City FC</option>
                        <option value="United Football Club">United Football Club</option>
                        <option value="Rangers Youth">Rangers Youth</option>
                        <option value="Athletic Academy">Athletic Academy</option>
                    </select>
                    <select id="ageGroupSelect" style="padding: 10px; border-radius: 8px; border: 1px solid #bdc3c7;">
                        <option value="">Age Group</option>
                        <option value="U6">Under 6</option>
                        <option value="U7">Under 7</option>
                        <option value="U8">Under 8</option>
                        <option value="U9">Under 9</option>
                        <option value="U10">Under 10</option>
                        <option value="U11">Under 11</option>
                        <option value="U12">Under 12</option>
                        <option value="U13">Under 13</option>
                        <option value="U14">Under 14</option>
                        <option value="U15">Under 15</option>
                        <option value="U16">Under 16</option>
                        <option value="U17">Under 17</option>
                        <option value="U18">Under 18</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <select id="teamSelect" style="padding: 10px; border-radius: 8px; border: 1px solid #bdc3c7;">
                        <option value="">Select Team</option>
                        <option value="Team A">Team A</option>
                        <option value="Team B">Team B</option>
                        <option value="Development Squad">Development Squad</option>
                        <option value="Academy Team">Academy Team</option>
                    </select>
                    <select id="locationSelect" style="padding: 10px; border-radius: 8px; border: 1px solid #bdc3c7;">
                        <option value="">Training Location</option>
                        <option value="Main Pitch">Main Pitch</option>
                        <option value="Training Ground A">Training Ground A</option>
                        <option value="Training Ground B">Training Ground B</option>
                        <option value="Indoor Facility">Indoor Facility</option>
                        <option value="School Grounds">School Grounds</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Session Themes (select all that apply):</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Rondos"> Rondos
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="1v1 Situations"> 1v1 Situations
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="2v2/3v3 and More Situations, Including Overloads"> 2v2/3v3 & Overloads
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Passing & Receiving"> Passing & Receiving
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Dribbling & Ball Control"> Dribbling & Ball Control
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Shooting & Finishing"> Shooting & Finishing
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Defending"> Defending
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Attacking"> Attacking
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Possession"> Possession
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Small Sided Games"> Small Sided Games
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Match Preparation"> Match Preparation
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Speed & Agility"> Speed & Agility
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Set Pieces"> Set Pieces
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Games & Activities"> Games & Activities
                        </label>
                    </div>
                    <label style="font-size: 14px; display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
                        <input type="checkbox" id="sessionThemeOther" onchange="toggleOtherSessionTheme()"> Other
                    </label>
                    <input type="text" id="sessionThemeOtherText" placeholder="Please specify other session theme(s)" 
                           style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7; display: none;">
                </div>
                <input type="date" id="sessionDate" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #bdc3c7;">
            </div>
            
            <div class="workflow-section">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Step 1: Mark Attendance</h3>
                <div class="player-grid">
                    <button class="player-btn attendance-btn" data-player="Jake Smith">
                        Jake Smith
                        <div class="attendance-badge" style="display: none;">‚úì</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Mike Johnson">
                        Mike Johnson
                        <div class="attendance-badge" style="display: none;">‚úì</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Sam Wilson">
                        Sam Wilson
                        <div class="attendance-badge" style="display: none;">‚úì</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Tom Brown">
                        Tom Brown
                        <div class="attendance-badge" style="display: none;">‚úì</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Alex Davis">
                        Alex Davis
                        <div class="attendance-badge" style="display: none;">‚úì</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Ryan Miller">
                        Ryan Miller
                        <div class="attendance-badge" style="display: none;">‚úì</div>
                    </button>
                </div>
            </div>
            
            <div class="workflow-section">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Step 2: Record Detailed Feedback</h3>
                <div class="player-grid">
                    <button class="player-btn feedback-btn" data-player="Jake Smith">Jake Smith</button>
                    <button class="player-btn feedback-btn" data-player="Mike Johnson">Mike Johnson</button>
                    <button class="player-btn feedback-btn" data-player="Sam Wilson">Sam Wilson</button>
                    <button class="player-btn feedback-btn" data-player="Tom Brown">Tom Brown</button>
                    <button class="player-btn feedback-btn" data-player="Alex Davis">Alex Davis</button>
                    <button class="player-btn feedback-btn" data-player="Ryan Miller">Ryan Miller</button>
                </div>
                
                <div class="feedback-categories" id="feedbackCategories" style="display: none;">
                    <h4 style="margin: 20px 0 10px 0; color: #2c3e50;">Feedback for <span id="selectedPlayerName"></span>:</h4>
                    
                    <div class="category-section">
                        <label style="font-weight: bold; color: #2c3e50;">‚≠ê Overall Performance:</label>
                        <select id="overallRating" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 5px; border: 1px solid #bdc3c7;">
                            <option value="">Select rating</option>
                            <option value="Excellent">Excellent</option>
                            <option value="Very Good">Very Good</option>
                            <option value="Good">Good</option>
                            <option value="Average">Average</option>
                            <option value="Needs Improvement">Needs Improvement</option>
                        </select>
                    </div>
                    
                    <div class="category-section">
                        <label style="font-weight: bold; color: #3498db;">üé§ Voice Feedback:</label>
                        <button class="record-mini-btn" data-category="feedback">üé§ Record Feedback</button>
                        <div class="audio-status" id="feedbackStatus"></div>
                    </div>
                    
                    <div class="category-section">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-weight: bold; color: #f39c12;">üèÜ Special mentions:</label>
                            <label style="font-size: 14px;"><input type="checkbox" id="specialMention"> Special mention</label>
                            <label style="font-size: 14px;"><input type="checkbox" id="playerOfSession"> Player of the session</label>
                        </div>
                    </div>
                    
                    <button class="save-feedback-btn" onclick="saveFeedback()" style="background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 20px; margin-top: 15px; cursor: pointer; width: 100%;">
                        üíæ Save & Sync to Google Sheets
                    </button>
                </div>
            </div>
            
            <div class="feedback-list">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Recent Feedback:</h3>
                <div id="feedbackList"></div>
                <button class="clear-btn" onclick="clearAllFeedback()">Clear All Feedback</button>
            </div>
            
            <div class="export-section">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">üìä Export & Sync</h3>
                <div id="syncStatus" class="sync-status" style="display: none;"></div>
                <button class="export-btn" onclick="syncToGoogleSheets()" id="syncBtn">üîÑ Sync All to Google Sheets</button>
                <button class="export-btn" onclick="exportCSV()">üìÅ Download CSV Backup</button>
                <button class="export-btn" onclick="exportToConsole()">üìã View Raw Data</button>
                <div id="dataPreview" class="data-preview" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedPlayer = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let feedbackData = [];
        let attendanceData = new Set();
        let currentFeedback = {};

        // Set today's date by default
        document.getElementById('sessionDate').valueAsDate = new Date();

        // Google Forms configuration
        const sheetsConfig = {
            formUrl: 'https://docs.google.com/forms/d/1d3iIcsetvYJLl_bz8M-2fGw7I156J8ThBhm0WTdicZM/formResponse',
            connected: true
        };

        // Handle session theme checkboxes
        function toggleOtherSessionTheme() {
            const otherCheckbox = document.getElementById('sessionThemeOther');
            const otherText = document.getElementById('sessionThemeOtherText');
            
            if (otherCheckbox.checked) {
                otherText.style.display = 'block';
                otherText.focus();
            } else {
                otherText.style.display = 'none';
                otherText.value = '';
            }
        }

        // Get the session themes as comma-separated string
        function getSessionThemes() {
            const checkboxes = document.querySelectorAll('input[name="sessionTheme"]:checked');
            const themes = Array.from(checkboxes).map(cb => cb.value);
            
            // Add "Other" text if specified
            const otherCheckbox = document.getElementById('sessionThemeOther');
            const otherText = document.getElementById('sessionThemeOtherText').value.trim();
            if (otherCheckbox.checked && otherText) {
                themes.push(otherText);
            }
            
            return themes.length > 0 ? themes.join(', ') : 'Not specified';
        }

        // Google Forms Integration Functions
        function testFormsConnection() {
            showStatus('connectionStatus', 'Testing Google Forms connection...', 'syncing');
            
            // Debug: Check if sheetsConfig exists
            console.log('sheetsConfig:', sheetsConfig);
            console.log('Form URL:', sheetsConfig.formUrl);
            
            // Test by submitting sample data using the entry field names directly
            const testData = {
                'entry.927744891': new Date().toISOString().split('T')[0],
                'entry.1435622968': 'Test Player',
                'entry.1206608925': 'Test Club',
                'entry.2004883478': 'Test Age Group',
                'entry.1645081746': 'Test Team',
                'entry.1226288223': 'Test Location',
                'entry.1493098807': 'Test Connection',
                'entry.534783448': 'Yes',
                'entry.2024761548': 'Test Rating',
                'entry.1473306623': 'No',
                'entry.1919403171': 'No',
                'entry.23037945': 'No',
                'entry.440393522': new Date().toLocaleString()
            };
            
            submitToGoogleForms(testData)
                .then(success => {
                    if (success) {
                        showStatus('connectionStatus', '‚úÖ Test successful! Check your Google Sheet for test data.', 'success');
                    } else {
                        showStatus('connectionStatus', '‚ùå Test failed. Check your form setup.', 'error');
                    }
                });
        }

        async function submitToGoogleForms(data) {
            try {
                console.log('Submitting data to Google Forms:', data);
                console.log('Form URL:', sheetsConfig.formUrl);
                
                // Create form data
                const formData = new FormData();
                
                // Handle all fields normally - let Google Forms handle the formatting
                Object.keys(data).forEach(key => {
                    formData.append(key, data[key]);
                    console.log(`Adding: ${key} = ${data[key]}`);
                });
                
                // Submit to Google Forms
                const response = await fetch(sheetsConfig.formUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: formData
                });
                
                console.log('Response status:', response.type);
                
                // Since it's no-cors, we can't read the response, but if no error thrown, assume success
                console.log('Data submitted to Google Forms - no errors thrown');
                return true;
                
            } catch (error) {
                console.error('Form submission error:', error);
                return false;
            }
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `sync-status ${type}`;
            element.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // Load existing feedback from memory
        function loadFeedback() {
            const saved = feedbackData;
            displayFeedback(saved);
        }

        // Attendance tracking (Step 1)
        document.querySelectorAll('.attendance-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const playerName = btn.dataset.player;
                
                // Toggle attendance
                if (attendanceData.has(playerName)) {
                    attendanceData.delete(playerName);
                    btn.classList.remove('present');
                    btn.querySelector('.attendance-badge').style.display = 'none';
                } else {
                    attendanceData.add(playerName);
                    btn.classList.add('present');
                    btn.querySelector('.attendance-badge').style.display = 'flex';
                }
                
                updateStatus();
            });
        });

        // Feedback selection (Step 2)
        document.querySelectorAll('.feedback-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedPlayer = btn.dataset.player;
                
                // Show feedback categories
                document.getElementById('feedbackCategories').style.display = 'block';
                document.getElementById('selectedPlayerName').textContent = selectedPlayer;
                
                // Reset feedback form
                resetFeedbackForm();
                updateStatus();
            });
        });
        
        function resetFeedbackForm() {
            currentFeedback = {};
            document.getElementById('overallRating').value = '';
            document.getElementById('specialMention').checked = false;
            document.getElementById('playerOfSession').checked = false;
            document.getElementById('feedbackStatus').textContent = '';
        }
        
        function updateStatus() {
            if (selectedPlayer) {
                const attendanceStatus = attendanceData.has(selectedPlayer) ? ' (Present)' : ' (Absent)';
                // Status shown in feedback categories section now
            } else {
                const attendanceCount = attendanceData.size;
                // Could show attendance count if needed
            }
        }

        // Recording functionality for categories
        document.querySelectorAll('.record-mini-btn').forEach(btn => {
            btn.addEventListener('mousedown', () => startCategoryRecording(btn));
            btn.addEventListener('mouseup', () => stopCategoryRecording(btn));
            btn.addEventListener('touchstart', () => startCategoryRecording(btn));
            btn.addEventListener('touchend', () => stopCategoryRecording(btn));
        });

        async function startCategoryRecording(btn) {
            const category = btn.dataset.category;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                recordedChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(blob);
                    
                    currentFeedback[category] = audioUrl;
                    document.getElementById('feedbackStatus').textContent = '‚úÖ Recorded';
                    btn.classList.remove('recording');
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                btn.classList.add('recording');
                document.getElementById('feedbackStatus').textContent = 'üî¥ Recording...';

            } catch (error) {
                console.error('Error accessing microphone:', error);
                document.getElementById('feedbackStatus').textContent = 'Error: Cannot access microphone';
            }
        }

        function stopCategoryRecording(btn) {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        async function saveFeedback() {
            if (!selectedPlayer) return;
            
            // Get session details
            const sessionDate = document.getElementById('sessionDate').value || new Date().toISOString().split('T')[0];
            const club = document.getElementById('clubSelect').value || 'Not specified';
            const ageGroup = document.getElementById('ageGroupSelect').value || 'Not specified';
            const team = document.getElementById('teamSelect').value || 'Not specified';
            const location = document.getElementById('locationSelect').value || 'Not specified';
            const sessionTheme = getSessionThemes();
            const attended = attendanceData.has(selectedPlayer);
            
            // Save complete feedback
            const feedback = {
                player: selectedPlayer,
                sessionDate: sessionDate,
                club: club,
                ageGroup: ageGroup,
                team: team,
                location: location,
                sessionTheme: sessionTheme,
                attended: attended,
                overallRating: document.getElementById('overallRating').value || 'Not rated',
                feedback: currentFeedback.feedback || null,
                specialMention: document.getElementById('specialMention').checked,
                playerOfSession: document.getElementById('playerOfSession').checked,
                timestamp: new Date().toLocaleString(),
                id: Date.now()
            };
            
            feedbackData.push(feedback);
            displayFeedback(feedbackData);
            
            // Auto-submit to Google Forms if connected
            if (sheetsConfig.connected) {
                try {
                    showStatus('syncStatus', 'Auto-syncing to Google Sheets...', 'syncing');
                    
                    const formData = {
                        'entry.927744891': feedback.sessionDate,
                        'entry.1435622968': feedback.player,
                        'entry.1206608925': feedback.club,
                        'entry.2004883478': feedback.ageGroup,
                        'entry.1645081746': feedback.team,
                        'entry.1226288223': feedback.location,
                        'entry.1493098807': feedback.sessionTheme,
                        'entry.534783448': feedback.attended ? 'Yes' : 'No',
                        'entry.2024761548': feedback.overallRating,
                        'entry.1473306623': feedback.specialMention ? 'Yes' : 'No',
                        'entry.1919403171': feedback.playerOfSession ? 'Yes' : 'No',
                        'entry.23037945': feedback.feedback ? 'Yes' : 'No',
                        'entry.440393522': feedback.timestamp
                    };
                    
                    const success = await submitToGoogleForms(formData);
                    if (success) {
                        showStatus('syncStatus', '‚úÖ Auto-synced to Google Sheets!', 'success');
                        feedback.synced = true;
                    } else {
                        showStatus('syncStatus', '‚ùå Auto-sync failed', 'error');
                    }
                } catch (error) {
                    showStatus('syncStatus', `‚ùå Auto-sync error: ${error.message}`, 'error');
                }
            }
            
            // Reset and hide form
            document.getElementById('feedbackCategories').style.display = 'none';
            document.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('selected'));
            selectedPlayer = null;
            
            alert(`Complete feedback saved for ${feedback.player}!`);
        }

        function displayFeedback(feedback) {
            const list = document.getElementById('feedbackList');
            list.innerHTML = '';

            feedback.slice(-10).reverse().forEach(item => {
                const badges = [];
                if (item.specialMention) badges.push('üèÜ Special Mention');
                if (item.playerOfSession) badges.push('‚≠ê Player of Session');
                if (item.synced) badges.push('‚òÅÔ∏è Synced');
                
                const div = document.createElement('div');
                div.className = 'feedback-item';
                div.innerHTML = `
                    <div class="feedback-header">
                        <span class="player-name">${item.player}</span>
                        <span class="timestamp">${item.sessionDate}</span>
                    </div>
                    <div style="font-size: 12px; color: #7f8c8d; margin: 5px 0;">
                        ${item.club} ‚Ä¢ ${item.ageGroup} ‚Ä¢ ${item.team} ‚Ä¢ ${item.location}<br>
                        Theme: ${item.sessionTheme} ‚Ä¢ ${item.attended ? '‚úÖ Present' : '‚ùå Absent'} ‚Ä¢ Rating: ${item.overallRating}
                    </div>
                    ${badges.length > 0 ? `<div style="margin: 5px 0; font-size: 12px;">${badges.join(' ‚Ä¢ ')}</div>` : ''}
                    <div style="margin: 10px 0;">
                        ${item.feedback ? `<button class="play-btn" onclick="playAudio('${item.feedback}')">‚ñ∂Ô∏è Play Feedback</button>` : ''}
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function playAudio(url) {
            const audio = new Audio(url);
            audio.play();
        }

        function clearAllFeedback() {
            if (confirm('Clear all feedback? This cannot be undone.')) {
                feedbackData = [];
                attendanceData.clear();
                document.querySelectorAll('.attendance-btn').forEach(btn => {
                    btn.classList.remove('present');
                    btn.querySelector('.attendance-badge').style.display = 'none';
                });
                document.querySelectorAll('.feedback-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                displayFeedback([]);
                selectedPlayer = null;
                updateStatus();
            }
        }

        async function syncToGoogleSheets() {
            if (!sheetsConfig.connected) {
                showStatus('syncStatus', 'Google Forms integration not available', 'error');
                return;
            }
            
            if (feedbackData.length === 0 && attendanceData.size === 0) {
                showStatus('syncStatus', 'No data to sync', 'error');
                return;
            }
            
            showStatus('syncStatus', 'Syncing to Google Sheets...', 'syncing');
            
            try {
                let successCount = 0;
                
                // Sync feedback data
                for (const feedback of feedbackData) {
                    if (!feedback.synced) {
                        const formData = {
                            'entry.927744891': feedback.sessionDate,
                            'entry.1435622968': feedback.player,
                            'entry.1206608925': feedback.club,
                            'entry.2004883478': feedback.ageGroup,
                            'entry.1645081746': feedback.team,
                            'entry.1226288223': feedback.location,
                            'entry.1493098807': feedback.sessionTheme,
                            'entry.534783448': feedback.attended ? 'Yes' : 'No',
                            'entry.2024761548': feedback.overallRating,
                            'entry.1473306623': feedback.specialMention ? 'Yes' : 'No',
                            'entry.1919403171': feedback.playerOfSession ? 'Yes' : 'No',
                            'entry.23037945': feedback.feedback ? 'Yes' : 'No',
                            'entry.440393522': feedback.timestamp
                        };
                        
                        const success = await submitToGoogleForms(formData);
                        if (success) {
                            feedback.synced = true;
                            successCount++;
                        }
                        
                        // Small delay between submissions
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                // Sync attendance-only records
                const sessionDate = document.getElementById('sessionDate').value || new Date().toISOString().split('T')[0];
                for (const player of attendanceData) {
                    if (!feedbackData.some(f => f.player === player)) {
                        const formData = {
                            'entry.927744891': sessionDate,
                            'entry.1435622968': player,
                            'entry.1206608925': document.getElementById('clubSelect').value || 'Not specified',
                            'entry.2004883478': document.getElementById('ageGroupSelect').value || 'Not specified',
                            'entry.1645081746': document.getElementById('teamSelect').value || 'Not specified',
                            'entry.1226288223': document.getElementById('locationSelect').value || 'Not specified',
                            'entry.1493098807': getSessionThemes(),
                            'entry.534783448': 'Yes',
                            'entry.2024761548': 'No feedback given',
                            'entry.1473306623': 'No',
                            'entry.1919403171': 'No',
                            'entry.23037945': 'No',
                            'entry.440393522': new Date().toLocaleString()
                        };
                        
                        const success = await submitToGoogleForms(formData);
                        if (success) successCount++;
                        
                        // Small delay between submissions
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                showStatus('syncStatus', `‚úÖ Successfully synced ${successCount} records to Google Sheets!`, 'success');
                
            } catch (error) {
                console.error('Sync error:', error);
                showStatus('syncStatus', `‚ùå Sync error: ${error.message}`, 'error');
            }
        }

        // Export functions
        function exportToConsole() {
            const sessionData = {
                session: {
                    club: document.getElementById('clubSelect').value || 'Not specified',
                    ageGroup: document.getElementById('ageGroupSelect').value || 'Not specified',
                    team: document.getElementById('teamSelect').value || 'Not specified',
                    date: document.getElementById('sessionDate').value || new Date().toISOString().split('T')[0],
                    sessionTheme: getSessionThemes()
                },
                attendance: Array.from(attendanceData),
                feedback: feedbackData.map(f => ({
                    player: f.player,
                    club: f.club,
                    ageGroup: f.ageGroup,
                    team: f.team,
                    attended: f.attended,
                    timestamp: f.timestamp,
                    hasAudio: !!f.feedback
                }))
            };
            
            console.log('Session Data:', JSON.stringify(sessionData, null, 2));
            
            const preview = document.getElementById('dataPreview');
            preview.innerHTML = `<pre>${JSON.stringify(sessionData, null, 2)}</pre>`;
            preview.style.display = 'block';
            
            alert('Data logged to console and displayed below. In production, this would auto-sync to Google Sheets.');
        }
        
        function exportCSV() {
            const headers = ['Date', 'Player', 'Club', 'Age Group', 'Team', 'Location', 'Session Theme', 'Attended', 'Overall Rating', 'Special Mention', 'Player of Session', 'Has Audio Feedback', 'Timestamp'];
            const rows = feedbackData.map(f => [
                f.sessionDate,
                f.player,
                f.club,
                f.ageGroup,
                f.team,
                f.location,
                f.sessionTheme,
                f.attended ? 'Yes' : 'No',
                f.overallRating,
                f.specialMention ? 'Yes' : 'No',
                f.playerOfSession ? 'Yes' : 'No',
                f.feedback ? 'Yes' : 'No',
                f.timestamp
            ]);
            
            // Add attendance-only records for players without feedback
            const sessionDate = document.getElementById('sessionDate').value || new Date().toISOString().split('T')[0];
            attendanceData.forEach(player => {
                if (!feedbackData.some(f => f.player === player)) {
                    rows.push([
                        sessionDate,
                        player,
                        document.getElementById('clubSelect').value || 'Not specified',
                        document.getElementById('ageGroupSelect').value || 'Not specified',
                        document.getElementById('teamSelect').value || 'Not specified',
                        document.getElementById('locationSelect').value || 'Not specified',
                        getSessionThemes(),
                        'Yes',
                        'No feedback given',
                        'No',
                        'No',
                        'No',
                        new Date().toLocaleString()
                    ]);
                }
            });
            
            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `football_session_${sessionDate}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize
        loadFeedback();
        updateStatus();
    </script>
</body>
</html>
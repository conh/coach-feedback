<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Feedback App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 25px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .main {
            padding: 30px 20px;
        }
        
        .player-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .workflow-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .player-btn {
            background: #ecf0f1;
            border: none;
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            position: relative;
        }
        
        .player-btn:hover {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
        }
        
        .feedback-btn.selected {
            background: #e74c3c;
            color: white;
        }
        
        .attendance-btn.present {
            background: #27ae60;
            color: white;
        }
        
        .attendance-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #27ae60;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .session-setup {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }
        
        .export-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
        }
        
        .export-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 5px;
        }
        
        .export-btn:hover {
            background: #219a52;
        }
        
        .category-section {
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .record-mini-btn {
            background: #e74c3c;
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            display: inline-block;
            margin: 5px 0;
            font-size: 14px;
            user-select: none;
            border: none;
        }
        
        .record-mini-btn:hover {
            background: #c0392b;
        }
        
        .record-mini-btn.recording {
            background: #27ae60;
            animation: pulse 1.5s infinite;
        }
        
        .audio-status {
            font-size: 12px;
            color: #7f8c8d;
            margin: 5px 0;
        }
        
        .feedback-categories {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .feedback-list {
            margin-top: 30px;
        }
        
        .feedback-item {
            background: #ecf0f1;
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .player-name {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .timestamp {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .play-btn {
            background: #3498db;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .play-btn:hover {
            background: #2980b9;
        }
        
        .clear-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }
        
        .success {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
            text-align: center;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #bdc3c7;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚽ Training Feedback</h1>
            <p>Quick feedback for your players</p>
        </div>

        <div class="main">
            <div class="session-setup">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Session Details:</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <select id="clubSelect" style="padding: 10px; border-radius: 8px; border: 1px solid #bdc3c7;">
                        <option value="">Select Club</option>
                        <option value="City FC">City FC</option>
                        <option value="United Football Club">United Football Club</option>
                        <option value="Rangers Youth">Rangers Youth</option>
                        <option value="Athletic Academy">Athletic Academy</option>
                    </select>
                    <select id="ageGroupSelect" style="padding: 10px; border-radius: 8px; border: 1px solid #bdc3c7;">
                        <option value="">Age Group</option>
                        <option value="U6">Under 6</option>
                        <option value="U7">Under 7</option>
                        <option value="U8">Under 8</option>
                        <option value="U9">Under 9</option>
                        <option value="U10">Under 10</option>
                        <option value="U11">Under 11</option>
                        <option value="U12">Under 12</option>
                        <option value="U13">Under 13</option>
                        <option value="U14">Under 14</option>
                        <option value="U15">Under 15</option>
                        <option value="U16">Under 16</option>
                        <option value="U17">Under 17</option>
                        <option value="U18">Under 18</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <select id="teamSelect" style="padding: 10px; border-radius: 8px; border: 1px solid #bdc3c7;">
                        <option value="">Select Team</option>
                        <option value="Team A">Team A</option>
                        <option value="Team B">Team B</option>
                        <option value="Development Squad">Development Squad</option>
                        <option value="Academy Team">Academy Team</option>
                    </select>
                    <select id="locationSelect" style="padding: 10px; border-radius: 8px; border: 1px solid #bdc3c7;">
                        <option value="">Training Location</option>
                        <option value="Main Pitch">Main Pitch</option>
                        <option value="Training Ground A">Training Ground A</option>
                        <option value="Training Ground B">Training Ground B</option>
                        <option value="Indoor Facility">Indoor Facility</option>
                        <option value="School Grounds">School Grounds</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">Session Themes (select all that apply):</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Rondos"> Rondos
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="1v1 Situations"> 1v1 Situations
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="2v2/3v3 and More Situations, Including Overloads"> 2v2/3v3 & Overloads
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Passing & Receiving"> Passing & Receiving
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Dribbling & Ball Control"> Dribbling & Ball Control
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Shooting & Finishing"> Shooting & Finishing
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Defending"> Defending
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Attacking"> Attacking
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Possession"> Possession
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Small Sided Games"> Small Sided Games
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Match Preparation"> Match Preparation
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Speed & Agility"> Speed & Agility
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Set Pieces"> Set Pieces
                        </label>
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="sessionTheme" value="Games & Activities"> Games & Activities
                        </label>
                    </div>
                    <label style="font-size: 14px; display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
                        <input type="checkbox" id="sessionThemeOther" onchange="toggleOtherSessionTheme()"> Other
                    </label>
                    <input type="text" id="sessionThemeOtherText" placeholder="Please specify other session theme(s)" 
                           style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7; display: none;">
                </div>
                <input type="date" id="sessionDate" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #bdc3c7;">
            </div>
            
            <div class="workflow-section">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Step 1: Mark Attendance</h3>
                <div class="player-grid">
                    <button class="player-btn attendance-btn" data-player="Jake Smith">
                        Jake Smith
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Mike Johnson">
                        Mike Johnson
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Sam Wilson">
                        Sam Wilson
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Tom Brown">
                        Tom Brown
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Alex Davis">
                        Alex Davis
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                    <button class="player-btn attendance-btn" data-player="Ryan Miller">
                        Ryan Miller
                        <div class="attendance-badge" style="display: none;">✓</div>
                    </button>
                </div>
            </div>
            
            <div class="workflow-section">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Step 2: Record Player Feedback</h3>
                <div class="player-grid">
                    <button class="player-btn feedback-btn" data-player="Jake Smith">Jake Smith</button>
                    <button class="player-btn feedback-btn" data-player="Mike Johnson">Mike Johnson</button>
                    <button class="player-btn feedback-btn" data-player="Sam Wilson">Sam Wilson</button>
                    <button class="player-btn feedback-btn" data-player="Tom Brown">Tom Brown</button>
                    <button class="player-btn feedback-btn" data-player="Alex Davis">Alex Davis</button>
                    <button class="player-btn feedback-btn" data-player="Ryan Miller">Ryan Miller</button>
                </div>
                
                <div class="feedback-categories" id="feedbackCategories" style="display: none;">
                    <h4 style="margin: 20px 0 10px 0; color: #2c3e50;">Feedback for <span id="selectedPlayerName"></span>:</h4>
                    
                    <div class="category-section">
                        <label style="font-weight: bold; color: #2c3e50;">⭐ Overall Performance:</label>
                        <select id="overallRating" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 5px; border: 1px solid #bdc3c7;">
                            <option value="">Select rating</option>
                            <option value="Excellent">Excellent</option>
                            <option value="Very Good">Very Good</option>
                            <option value="Good">Good</option>
                            <option value="Average">Average</option>
                            <option value="Needs Improvement">Needs Improvement</option>
                        </select>
                    </div>
                    
                    <div class="category-section">
                        <label style="font-weight: bold; color: #3498db;">🎤 Voice Feedback:</label>
                        <p style="font-size: 12px; color: #7f8c8d; margin: 5px 0;">Hold to record, release to stop</p>
                        <button class="record-mini-btn" data-category="feedback">🎤 Record Feedback</button>
                        <div class="audio-status" id="feedbackStatus"></div>
                    </div>
                    
                    <div class="category-section">
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <label style="font-weight: bold; color: #f39c12;">🏆 Special mentions:</label>
                            <label style="font-size: 14px;"><input type="checkbox" id="specialMention"> Special mention</label>
                            <label style="font-size: 14px;"><input type="checkbox" id="playerOfSession"> Player of the session</label>
                        </div>
                    </div>
                    
                    <button class="save-feedback-btn" onclick="saveFeedback()" style="background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 20px; margin-top: 15px; cursor: pointer; width: 100%;">
                        💾 Save Feedback
                    </button>
                </div>
            </div>
            
            <div class="feedback-list">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Session Summary:</h3>
                <div id="feedbackList"></div>
                <button class="clear-btn" onclick="clearAllFeedback()">Clear All Data</button>
            </div>
            
            <div class="export-section">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">📁 Export Session Data</h3>
                <p style="margin-bottom: 15px; color: #7f8c8d; font-size: 14px;">Download your session data to upload to your preferred spreadsheet system</p>
                <button class="export-btn" onclick="exportCSV()">📁 Download Session Data</button>
            </div>
        </div>
    </div>

    <script>
        let selectedPlayer = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let feedbackData = [];
        let attendanceData = new Set();
        let currentFeedback = {};

        // Set today's date by default
        document.getElementById('sessionDate').valueAsDate = new Date();

        // Handle session theme checkboxes
        function toggleOtherSessionTheme() {
            const otherCheckbox = document.getElementById('sessionThemeOther');
            const otherText = document.getElementById('sessionThemeOtherText');
            
            if (otherCheckbox.checked) {
                otherText.style.display = 'block';
                otherText.focus();
            } else {
                otherText.style.display = 'none';
                otherText.value = '';
            }
        }

        // Get the session themes as comma-separated string
        function getSessionThemes() {
            const checkboxes = document.querySelectorAll('input[name="sessionTheme"]:checked');
            const themes = Array.from(checkboxes).map(cb => cb.value);
            
            // Add "Other" text if specified
            const otherCheckbox = document.getElementById('sessionThemeOther');
            const otherText = document.getElementById('sessionThemeOtherText').value.trim();
            if (otherCheckbox.checked && otherText) {
                themes.push(otherText);
            }
            
            return themes.length > 0 ? themes.join(', ') : 'Not specified';
        }

        // Attendance tracking (Step 1)
        document.querySelectorAll('.attendance-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const playerName = btn.dataset.player;
                
                // Toggle attendance
                if (attendanceData.has(playerName)) {
                    attendanceData.delete(playerName);
                    btn.classList.remove('present');
                    btn.querySelector('.attendance-badge').style.display = 'none';
                } else {
                    attendanceData.add(playerName);
                    btn.classList.add('present');
                    btn.querySelector('.attendance-badge').style.display = 'flex';
                }
            });
        });

        // Feedback selection (Step 2)
        document.querySelectorAll('.feedback-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedPlayer = btn.dataset.player;
                
                // Show feedback categories
                document.getElementById('feedbackCategories').style.display = 'block';
                document.getElementById('selectedPlayerName').textContent = selectedPlayer;
                
                // Reset feedback form
                resetFeedbackForm();
            });
        });
        
        function resetFeedbackForm() {
            currentFeedback = {};
            document.getElementById('overallRating').value = '';
            document.getElementById('specialMention').checked = false;
            document.getElementById('playerOfSession').checked = false;
            document.getElementById('feedbackStatus').textContent = '';
        }

        // Recording functionality for categories
        document.querySelectorAll('.record-mini-btn').forEach(btn => {
            btn.addEventListener('mousedown', () => startCategoryRecording(btn));
            btn.addEventListener('mouseup', () => stopCategoryRecording(btn));
            btn.addEventListener('touchstart', () => startCategoryRecording(btn));
            btn.addEventListener('touchend', () => stopCategoryRecording(btn));
        });

        async function startCategoryRecording(btn) {
            const category = btn.dataset.category;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                recordedChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(blob);
                    
                    currentFeedback[category] = audioUrl;
                    document.getElementById('feedbackStatus').textContent = '✅ Recorded';
                    btn.classList.remove('recording');
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                btn.classList.add('recording');
                document.getElementById('feedbackStatus').textContent = '🔴 Recording...';

            } catch (error) {
                console.error('Error accessing microphone:', error);
                document.getElementById('feedbackStatus').textContent = 'Error: Cannot access microphone';
            }
        }

        function stopCategoryRecording(btn) {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        function saveFeedback() {
            if (!selectedPlayer) return;
            
            // Get session details
            const sessionDate = document.getElementById('sessionDate').value || new Date().toISOString().split('T')[0];
            const club = document.getElementById('clubSelect').value || 'Not specified';
            const ageGroup = document.getElementById('ageGroupSelect').value || 'Not specified';
            const team = document.getElementById('teamSelect').value || 'Not specified';
            const location = document.getElementById('locationSelect').value || 'Not specified';
            const sessionTheme = getSessionThemes();
            const attended = attendanceData.has(selectedPlayer);
            
            // Save complete feedback
            const feedback = {
                player: selectedPlayer,
                sessionDate: sessionDate,
                club: club,
                ageGroup: ageGroup,
                team: team,
                location: location,
                sessionTheme: sessionTheme,
                attended: attended,
                overallRating: document.getElementById('overallRating').value || 'Not rated',
                feedback: currentFeedback.feedback || null,
                specialMention: document.getElementById('specialMention').checked,
                playerOfSession: document.getElementById('playerOfSession').checked,
                timestamp: new Date().toLocaleString(),
                id: Date.now()
            };
            
            feedbackData.push(feedback);
            displayFeedback(feedbackData);
            
            // Reset and hide form
            document.getElementById('feedbackCategories').style.display = 'none';
            document.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('selected'));
            selectedPlayer = null;
            
            alert(`Feedback saved for ${feedback.player}!`);
        }

        function displayFeedback(feedback) {
            const list = document.getElementById('feedbackList');
            list.innerHTML = '';

            if (feedback.length === 0) {
                list.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 20px;">No feedback recorded yet</p>';
                return;
            }

            feedback.slice(-10).reverse().forEach(item => {
                const badges = [];
                if (item.specialMention) badges.push('🏆 Special Mention');
                if (item.playerOfSession) badges.push('⭐ Player of Session');
                
                const div = document.createElement('div');
                div.className = 'feedback-item';
                div.innerHTML = `
                    <div class="feedback-header">
                        <span class="player-name">${item.player}</span>
                        <span class="timestamp">${item.sessionDate}</span>
                    </div>
                    <div style="font-size: 12px; color: #7f8c8d; margin: 5px 0;">
                        ${item.attended ? '✅ Present' : '❌ Absent'} • Rating: ${item.overallRating}
                    </div>
                    ${badges.length > 0 ? `<div style="margin: 5px 0; font-size: 12px;">${badges.join(' • ')}</div>` : ''}
                    <div style="margin: 10px 0;">
                        ${item.feedback ? `<button class="play-btn" onclick="playAudio('${item.feedback}')">▶️ Play Feedback</button>` : ''}
                    </div>
                `;
                list.appendChild(div);
            });

            // Show summary
            const attendanceCount = attendanceData.size;
            const feedbackCount = feedback.length;
            const summary = document.createElement('div');
            summary.style.cssText = 'background: #3498db; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-size: 14px;';
            summary.innerHTML = `📊 Session Summary: ${attendanceCount} players present • ${feedbackCount} feedback recorded`;
            list.insertBefore(summary, list.firstChild);
        }

        function playAudio(url) {
            const audio = new Audio(url);
            audio.play().catch(error => {
                alert('Could not play audio. Please check your browser settings.');
            });
        }

        function clearAllFeedback() {
            if (confirm('Clear all session data? This cannot be undone.')) {
                feedbackData = [];
                attendanceData.clear();
                document.querySelectorAll('.attendance-btn').forEach(btn => {
                    btn.classList.remove('present');
                    btn.querySelector('.attendance-badge').style.display = 'none';
                });
                document.querySelectorAll('.feedback-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                document.getElementById('feedbackCategories').style.display = 'none';
                selectedPlayer = null;
                displayFeedback([]);
            }
        